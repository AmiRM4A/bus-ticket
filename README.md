# سیستم مدیریت بلیط اتوبوس

یک اپلیکیشن بک‌اند جامع برای مدیریت بلیط اتوبوس که بر پایه فریمورک Laravel و با استفاده از پکیج `nwidart/laravel-modules` برای معماری ماژولار توسعه یافته است.
## معرفی

این سیستم یک راه‌حل کامل برای رزرو و مدیریت بلیط اتوبوس است که با هدف راه‌اندازی توسعه‌دهندگان جدید طراحی شده است. در این مستند، ویژگی‌ها، فرآیندها و منطق کسب‌وکار با ارجاع مستقیم به موجودیت‌های پایگاه داده و سرویس‌های اصلی تشریح می‌شوند.
## معماری سیستم

### ماژول کاربران (Users)

**مسئولیت**: مدیریت ثبت‌نام و احراز هویت کاربران

**موجودیت‌های اصلی**:

- `users` - اطلاعات کاربران (`id`, `name`, `email`, `password`)

**ویژگی‌ها**:

- احراز هویت ایمیل/رمز عبور
- صدور توکن Sanctum پس از ورود موفق
- عدم پوشش سیستم نقش‌ها و سطوح دسترسی

### ماژول رانندگان (Drivers)

**مسئولیت**: مدیریت اطلاعات رانندگان

**موجودیت‌های اصلی**:

- `drivers` - اطلاعات رانندگان (`id`, `name`, `mobile`)

**ویژگی‌ها**:

- امکان تخصیص یک راننده به چندین اتوبوس

### ماژول اتوبوس‌ها (Buses)

**مسئولیت**: مدیریت ناوگان و ساختار صندلی‌ها

**موجودیت‌های اصلی**:

- `buses` - اطلاعات اتوبوس‌ها (`id`, `model`, `plate`, `seats_count`)
- `bus_seats` - صندلی‌های اتوبوس (`id`, `bus_id`, `seat_number`)

**ویژگی‌ها**:

- تعریف صندلی‌ها با ستون (A/B/C/D) و ردیف
- منحصر بودن شماره صندلی در هر اتوبوس

### ماژول مکان‌ها (Locations)

**مسئولیت**: تعریف مبدأ و مقصد سفرها

**موجودیت‌های اصلی**:

- `provinces` - استان‌ها (`id`, `name`)

**ویژگی‌ها**:

- استفاده در تعریف `from_province_id` و `to_province_id` سفرها

### ماژول سفرها (Trips)

**مسئولیت**: هسته اصلی سیستم - مدیریت سفرها، صندلی‌ها و رزروها

**موجودیت‌های اصلی**:

- `trips` - سفرها (`id`, `bus_id`, `from_province_id`, `to_province_id`, `departure_time`, `price_per_seat`)
- `trip_seats` - وضعیت صندلی‌ها (`id`, `trip_id`, `bus_seat_id`, `status`, `reserved_gender`, `expires_at`)
- `trip_reservations` - رزروهای نهایی (`id`, `user_id`, `trip_seat_id`, `passenger_id`, `order_item_id`)

**قوانین کلیدی**:

- **انقضای رزرو**: رزرو موقت 10 دقیقه معتبر است (پس از ۱۰ دقیقه اگر سفارش صندلی‌ها پرداخت نشده باشد، کامند تعریف شده (Schedule شده)، صندلی‌ها را به حالت اولیه یعنی "Available" باز میگرداند تا دوباره قابل رزرود توسط دیگر کاربران باشند.)
- **محدودیت جنسیت**: عدم امکان رزرو صندلی مجاور با جنسیت مخالف
- **کنترل همزمانی**: استفاده از Transaction و قفل ردیف‌ها

### ماژول مسافران (Passengers)

**مسئولیت**: ذخیره اطلاعات مسافران

**موجودیت‌های اصلی**:

- `passengers` - اطلاعات مسافران (`id`, `first_name`, `last_name`, `mobile`, `national_code`, `gender`)

**ویژگی‌ها**:

- امکان داشتن چندین بلیط توسط هر مسافر

### ماژول سفارشات (Orders)

**مسئولیت**: مدیریت فرآیند رزرو از ایجاد تا پرداخت

**موجودیت‌های اصلی**:

- `orders` - سفارشات (`id`, `user_id`, `status`)
  - وضعیت‌ها: `pending`, `completed`, `failed`, `cancelled`
- `order_items` - آیتم‌های سفارش (`id`, `order_id`, `trip_seat_id`, `passenger_id`, `price`)

**منطق کسب‌وکار**:

- لغو کامل سفارش در صورت لغو تمام آیتم‌ها
- امکان لغو جزئی و پرداخت باقی‌مانده

### ماژول پرداخت‌ها (Payments)

**مسئولیت**: پردازش پرداخت سفارشات

**موجودیت‌های اصلی**:

- `payments` - پرداخت‌ها (`id`, `order_id`, `transaction_id`, `amount`, `status`)
  - وضعیت‌ها: `pending`, `completed`, `failed`

**فرآیند پردازش**:

1. ایجاد رکورد پرداخت `pending`
2. بازگرداندن لینک درگاه پرداخت
3. اعتبارسنجی پاسخ درگاه
4. تکمیل یا شکست بر اساس نتیجه

## فرآیند کسب‌وکار

### 1. احراز هویت

کاربر ثبت‌نام/ورود و دریافت توکن احراز هویت

### 2. جستجوی سفر

مشاهده لیست سفرها با فیلترهای مبدأ، مقصد و تاریخ

### 3. انتخاب سفر و صندلی

دریافت نقشه صندلی‌ها و وضعیت هر صندلی (موجود/رزرو شده/فروخته شده)

### 4. رزرو موقت صندلی

- قفل کردن صندلی‌های درخواستی در پایگاه داده
- بررسی عدم تداخل جنسیتی با صندلی‌های مجاور
- تغییر وضعیت به `reserved` و تنظیم زمان انقضا
- ایجاد سفارش `pending`

### 5. پرداخت

- ارسال شناسه سفارش به endpoint پرداخت
- دریافت لینک درگاه پرداخت
- هدایت کاربر به callback پس از پردازش

### 6. تکمیل فرآیند

**موفق**:

- تایید تراکنش
- تغییر وضعیت سفارش/پرداخت به `completed`
- تغییر وضعیت صندلی‌ها به `sold`
- ثبت در `trip_reservations`

**ناموفق**:

- تغییر وضعیت به `failed`
- آزادسازی صندلی‌های رزرو شده
- امکان تلاش مجدد تا 10 دقیقه

## مستندات API

### ساختار استاندارد پاسخ‌ها

```json  
{  
  "status": "HTTP_STATUS_CODE",  "message": "MESSAGE_OF_RESPONSE",  "data": "NULL | DATA_OBJECT"}  
```  

### مدیریت خطاها

**خطای اعتبارسنجی (422)**:

```json  
{  
  "status": 422,  
  "message": "اطلاعات ارسال شده نامعتبر است.",  
  "data": {  
    "errors": {  
      "field_name": ["error_message"]  
    }  
  }  
}  
```  

**خطای عدم احراز هویت (401)**:

```json  
{  
  "message": "Unauthenticated."  
}  
```  

### احراز هویت

تمام درخواست‌ها باید حاوی توکن JWT در هدر Authorization باشند:

```  
Authorization: Bearer {token}  
```  

## اندپوینت‌های کاربران

### ثبت‌نام کاربر

```http  
POST /v1/user/register  
```  

**پارامترها**:

|نام|نوع|اجباری|توضیحات|  
|---|---|---|---|  
|name|string|✓|نام کاربر|  
|email|string|✓|ایمیل کاربر|  
|password|string|✓|رمز عبور|  
|password_confirmation|string|✓|تکرار رمز عبور|  

**پاسخ موفق (201)**:

```json  
{  
  "status": 201,  
  "message": "کاربر با موفقیت ثبت نام شد",  
  "data": {  
    "user": {  
      "id": 1,  
      "name": "علی رضایی",  
      "email": "ali.rezaei@example.com",  
      "created_at": "2025-09-03T10:00:00Z"  
    },  
    "token": "1|aBcDeFgHiJkLmNoPqRsTuVwXyZ123456"  
  }  
}  
```  

### ورود کاربر

```http  
POST /v1/user/login  
```  

**پارامترها**:

|نام|نوع|اجباری|توضیحات|  
|---|---|---|---|  
|email|string|✓|ایمیل کاربر|  
|password|string|✓|رمز عبور|  

**پاسخ موفق (200)**:

```json  
{  
  "status": 200,  
  "message": "ورود با موفقیت انجام شد",  
  "data": {  
    "user": {  
      "id": 1,  
      "name": "علی رضایی",  
      "email": "ali.rezaei@example.com"  
    },  
    "token": "1|aBcDeFgHiJkLmNoPqRsTuVwXyZ123456"  
  }  
}  
```  

**پاسخ خطا (401)**:

```json  
{  
  "status": 401,  "message": "ایمیل یا رمز عبور اشتباه است",  
  "data": null}  
```  

### خروج کاربر

```http  
POST /v1/user/logout  
```  

_احراز هویت: مورد نیاز_

**پاسخ موفق (200)**:

```json  
{  
  "status": 200,  
  "message": "خروج با موفقیت انجام شد",  
  "data": null  
}  
```  

### اطلاعات کاربر جاری

```http  
GET /v1/user  
```  

_احراز هویت: مورد نیاز_

**پاسخ موفق (200)**:

```json  
{  
  "status": 200,  
  "message": "عملیات با موفقیت انجام شد",  
  "data": {  
    "id": 1,  
    "name": "علی رضایی",  
    "email": "ali.rezaei@example.com",  
    "created_at": "2025-09-03T10:00:00Z"  
  }  
}  
```  

## اندپوینت‌های سفرها

### لیست سفرها

```http  
GET /v1/trips  
```  

_احراز هویت: مورد نیاز_

**پارامترهای اختیاری**:

|نام|نوع|توضیحات|  
|---|---|---|  
|bus_id|integer|فیلتر بر اساس شناسه اتوبوس|  
|from_province_id|integer|فیلتر مبدأ|  
|to_province_id|integer|فیلتر مقصد|  
|min_price|decimal|حداقل قیمت|  
|max_price|decimal|حداکثر قیمت|  
|per_page|integer|تعداد نتایج در هر صفحه (پیش‌فرض: 20)|  

**پاسخ موفق (200)**:

```json  
{  
  "status": 200,  
  "message": "عملیات با موفقیت انجام شد",  
  "data": {  
    "items": [  
      {  
        "id": 1,  
        "bus": {  
          "id": 1,  
          "model": "ولوو B9R",  
          "plate": "۱۲ع۳۴۵-۶۷",  
          "seats_count": 44  
        },  
        "origin": {  
          "id": 1,  
          "name": "تهران"  
        },  
        "destination": {  
          "id": 2,  
          "name": "اصفهان"  
        },  
        "total_seats": 44,  
        "reserved_seats_count": 0,  
        "trip_date": "2025-10-20",  
        "departure_time": "23:00:00",  
        "arrived_at": null,  
        "created_at": "2025-09-03T12:00:00Z",  
        "updated_at": "2025-09-03T12:00:00Z"  
      }  
    ],  
    "meta": {  
      "current_page": 1,  
      "last_page": 1,  
      "per_page": 20,  
      "total": 15  
    }  
  }  
}  
```  

### جزئیات سفر

```http  
GET /v1/trips/{trip_id}  
```  

_احراز هویت: مورد نیاز_

**پاسخ موفق (200)**:

```json  
{  
  "status": 200,  
  "message": "عملیات با موفقیت انجام شد",  
  "data": {  
    "id": 1,  
    "bus": {  
      "id": 1,  
      "model": "ولوو B9R",  
      "plate": "۱۲ع۳۴۵-۶۷",  
      "seats_count": 44  
    },  
    "seats": [  
      {  
        "id": 1,  
        "status": "AVAILABLE",  
        "name": "صندلی ۱",  
        "row": 1,  
        "column": "A",  
        "reserved_gender": null,  
        "is_available": true,  
        "is_reserved": false,  
        "is_sold": false  
      },  
      {  
        "id": 2,  
        "status": "SOLD",  
        "name": "صندلی ۲",  
        "row": 1,  
        "column": "B",  
        "reserved_gender": "مرد",  
        "is_available": false,  
        "is_reserved": false,  
        "is_sold": true  
      }  
    ],  
    "origin": {  
      "id": 1,  
      "name": "تهران"  
    },  
    "destination": {  
      "id": 2,  
      "name": "اصفهان"  
    },  
    "trip_date": "2025-10-20",  
    "departure_time": "23:00:00"  
  }  
}  
```  

### ایجاد رزرو

```http  
POST /v1/trips  
```  

_احراز هویت: مورد نیاز_

**پارامترها**:

| نام                        | نوع     | اجباری | توضیحات               |
| -------------------------- | ------- | ------ | --------------------- |
| trip_id                    | integer | ✓      | شناسه سفر             |
| passengers                 | array   | ✓      | آرایه اطلاعات مسافران |
| passengers[].trip_seat_id  | integer | ✓      | شناسه صندلی سفر       |
| passengers[].first_name    | string  | ✓      | نام                   |
| passengers[].last_name     | string  | ✓      | نام خانوادگی          |
| passengers[].mobile        | string  | ✓      | شماره موبایل          |
| passengers[].national_code | string  | ✓      | کد ملی                |
| passengers[].gender        | integer | ✓      | جنسیت (0: زن، 1: مرد) |

**پاسخ موفق (201)**:

```json  
{  
  "status": 201,  "message": "رزرو با موفقیت ایجاد شد",  
  "data": {    "id": 1,    "status": "pending",    "total_amount": 450000,    "created_at": "2025-09-03T14:10:00Z"  }}  
```  

**پاسخ خطا (400)**:

```json  
{  
  "status": 400,  "message": "صندلی 5 دیگر در دسترس نیست",  
  "data": null}  
```  

**پاسخ خطا (409)**:

```json  
{  
  "status": 409,  
  "message": "صندلی x به دلیل تداخل سیاست جنسیتی با صندلی مجاور y قابل رزرو نیست",  
  "data": null  
}  
```  

## اندپوینت‌های سفارشات

### جزئیات سفارش

```http  
GET /v1/orders/{order_id}  
```  

_احراز هویت: مورد نیاز_

**پاسخ موفق (200)**:

```json  
{  
  "status": 200,  
  "message": "عملیات با موفقیت انجام شد",  
  "data": {  
    "id": 1,  
    "status": "pending",  
    "total_amount": 900000,  
    "created_at": "2025-09-03T14:00:00Z",  
    "expires_at": "2025-09-03T14:10:00Z",  
    "items": [  
      {  
        "trip_seat_id": 5,  
        "seat_number": "5A",  
        "passenger": {  
          "first_name": "سارا",  
          "last_name": "محمدی",  
          "national_code": "0012345678"  
        },  
        "price": 450000  
      }  
    ],  
    "trip": {  
      "from_province": "تهران",  
      "to_province": "اصفهان",  
      "trip_date": "2025-10-20",  
      "departure_time": "23:00:00"  
    }  
  }  
}  
```  

### پرداخت سفارش

```http  
GET /v1/orders/checkout/{order_id}  
```  

_احراز هویت: مورد نیاز_

**پاسخ موفق (200)**:

```json  
{  
  "status": 200,  
  "message": "عملیات با موفقیت انجام شد",  
  "data": {  
    "payment_url": "https://gateway.example.com/pay/a1b2c3d4e5f6",  
    "transaction_id": "c69186cb-6a3f-41f1-8538-1d0fa71e5268a",  
    "amount": 900000  
  }  
}  
```  


### لغو سفارش/آیتم‌های سفارش

از این اندپوینت برای لغو صندلی/صندلی‌های رزرو شده استفاده شود (فقط زمانی امکان لغو صندلی/صندلی‌ها وجود خواهد داشت که سفارش پرداخت نشده باشد)
**توجه**: درصورت ارسال نشده پارامتر item_ids، کل سفارش لغو خواهد شد. در غیر این صورت، فقط آیتم‌های ارسالی در پارامتر item_ids لغو خواهند شد و سفارش قابل پرداخت خواهد بود.

```http  
DELETE /v1/orders/{order_id}  
```  

_احراز هویت: مورد نیاز_

**پارامترهای اختیاری**:

| نام      | نوع   | توضیحات                              |
| -------- | ----- | ------------------------------------ |
| item_ids | array | آرایه‌ای از شناسه‌های آیتم‌های سفارش |

**پاسخ موفق (200)**:

```json  
{  
  "status": 200,  
  "message": "عملیات با موفقیت انجام شد",  
  "data": null  
}  
```  



## اندپوینت‌های پرداخت‌ها

### تایید پرداخت

```http  
GET /v1/payments/callback/{transaction_id}  
```  

**پاسخ موفق (200)**:

```json  
{  
  "status": 200,  "message": "پرداخت با موفقیت تایید شد",  
  "data": {    "id": 1,    "status": "completed",    "paid_at": "2025-09-03T14:05:15Z"  }}  
```  

**پاسخ خطا (404)**:

```json  
{  
  "status": 404,  
  "message": "تراکنش نامعتبر است یا درحال حاضر تایید شده است.",  
  "data": null  
}  
```